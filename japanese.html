<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>五十音練習 - My GitHub</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* 當前頁面底線 */
    .top-nav a.active::after { transform: scaleX(1); }

    /* 表格：放大 + hover 高亮 + 可點擊 */
    .kana-chart table { width:100%; border-collapse:collapse; margin-bottom:1.5rem; font-size:1.2rem; }
    .kana-chart th, .kana-chart td {
      border:1px solid #444; padding:0.75rem; text-align:center; color:#eee;
      transition: background 0.3s; cursor: pointer;
    }
    .kana-chart th { background:#333; cursor: default; }
    .kana-chart td:hover { background:#555; }

    /* 測驗模式按鈕 */
    .quiz-modes { text-align:center; margin-top:2rem; }
    .quiz-buttons { display:flex; justify-content:center; gap:1rem; flex-wrap:wrap; }
    .quiz-buttons button{
      padding:0.6rem 1.2rem; border:2px solid #fff; border-radius:0.25rem;
      background:transparent; color:#fff; cursor:pointer; font-size:1rem; position:relative;
    }
    .quiz-buttons button::after{
      content:""; position:absolute; bottom:-2px; left:0; width:100%; height:2px;
      background:currentColor; transform:scaleX(0); transform-origin:left; transition:transform .3s ease;
    }
    .quiz-buttons button:hover::after,.quiz-buttons button:focus::after{ transform:scaleX(1); }

    /* 設定區（選擇題） */
    #multiple-setup{
      max-width:500px; margin:2rem auto; padding:1.5rem; background:rgba(50,50,50,.9);
      border:1px solid #555; border-radius:.75rem; box-shadow:0 4px 8px rgba(0,0,0,.5); color:#fff;
    }
    #multiple-setup h4{ margin-bottom:1rem; font-size:1.25rem; }
    .quiz-setup label{ display:block; margin-bottom:.75rem; cursor:pointer; font-size:1rem; }
    .quiz-setup input[type="checkbox"]{ margin-right:.5rem; transform:scale(1.2); }
    #start-multiple{
      margin-top:1rem; padding:.6rem 1.2rem; background:#1e90ff; border:none; border-radius:.5rem;
      color:#fff; cursor:pointer; font-size:1.1rem;
    }
    #start-multiple:hover{ background:#1c86ee; }

    /* 選擇題區（固定 2×2） */
    .quiz-question{ text-align:center; margin-top:2rem; color:#fff; }
    #question-text{ font-size:2.2rem; margin-bottom:1rem; }
    .choices{
      display:grid; grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap:1.25rem; max-width: 560px; margin: 0 auto .5rem;
    }
    @media (max-width: 420px){
      .choices{ grid-template-columns: 1fr; max-width: 340px; }
    }
    .choice{ display:flex; flex-direction:column; align-items:center; width:100%; }
    .choice button{
      width:100%; height:56px; padding:0 1rem; background:#444; border:none; border-radius:.5rem;
      color:#fff; cursor:pointer; font-size:1.2rem; transition: background .3s;
    }
    .choice button:hover{ background:#555; }
    .choice button.correct{ background:#2e8b57; } /* 綠 */
    .choice button.wrong{ background:#8b2e2e; }   /* 紅 */
    .choice .romaji{
      margin-top:.5rem; min-height:1.2rem; font-size:1rem; color:#ccc; visibility:hidden;
    }
    .choice.revealed .romaji{ visibility:visible; }

    .controls{ margin-top:1.25rem; display:flex; justify-content:center; gap:1rem; }
    .controls button{
      padding:.5rem 1rem; background:#666; border:none; border-radius:.5rem;
      color:#fff; cursor:pointer; font-size:1rem; transition:background .3s;
    }
    .controls button:hover{ background:#777; }

    /* === 拼圖模式 === */
    .puzzle-container{ display:none; margin-top:1rem; color:#fff;
      /* 預設留白，避免 sticky 行/列撞到 footer；JS 會再動態加大 */
      padding-bottom: 12vh;
    }

    .puzzle-actions{
      display:flex; justify-content:center; align-items:center; gap:0.75rem; flex-wrap:wrap; margin-bottom:0.75rem;
    }
    .puzzle-actions button{
      padding:.5rem 1rem; background:#1e90ff; border:none; border-radius:.5rem; color:#fff; cursor:pointer;
    }
    .puzzle-actions button.secondary{ background:#666; }
    .puzzle-actions button:hover{ filter:brightness(1.05); }
    .timer-box{
      display:flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border:1px solid #555; border-radius:.5rem; background:#2a2a2a; color:#ddd;
    }
    #timer-display{ font-variant-numeric: tabular-nums; font-weight:600; }

    /* === 拼圖模式設定面板 === */
    #puzzle-setup{
      max-width:520px; margin:2rem auto; padding:1.25rem 1.5rem; background:rgba(50,50,50,.9);
      border:1px solid #555; border-radius:.75rem; box-shadow:0 4px 8px rgba(0,0,0,.5); color:#fff; display:none;
    }
    #puzzle-setup h4{ margin-bottom:1rem; font-size:1.25rem; }
    .setup-row{ display:flex; align-items:center; gap:1rem; margin:.5rem 0 1rem; flex-wrap:wrap; }
    .setup-row > span{ opacity:.85; }
    .setup-row label{ cursor:pointer; }
    .setup-actions{ display:flex; gap:.5rem; justify-content:flex-end; }
    .setup-actions .secondary{ background:#666; }

    /* === 可拖曳的籃子（視窗樣式） === */
    .tile-pool-wrap{
      position: fixed;
      right: 16px; bottom: 16px; /* 退路：若右側空間不足就用這個位置 */
      width: min(380px, 34vw);
      z-index: 50; display:none;
    }
    .tile-pool-header{
      background:#333; border:1px solid #555; border-bottom:none; color:#ddd;
      padding:.4rem .75rem; border-radius:.75rem .75rem 0 0; cursor:move; user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:.5rem;
    }
    .tile-pool{
      position: relative; /* 供內部絕對定位 */
      height: 38vh; min-height: 220px; max-height: 50vh;
      border:1px dashed #555; border-radius:0 0 .75rem .75rem;
      background: rgba(255,255,255,0.03);
      overflow: auto;              /* ✅ 籃子內可捲動 */
      overscroll-behavior: contain;/* 避免滾到邊緣時帶動整頁 */
    }
    .tile{
      position:absolute;
      min-width:76px; height:48px; padding:0 .75rem;
      background:#444; color:#fff; border:1px solid #666; border-radius:.5rem;
      display:flex; align-items:center; justify-content:center;
      cursor:grab; user-select:none;
    }
    .tile:active{ cursor:grabbing; }
    .tile.placed{ position:static !important; min-width:auto; height:auto; cursor:default; }

    .puzzle-grid{
      --cell: 76px;
      display:grid;
      grid-template-columns: 72px repeat(5, var(--cell));
      gap:6px;
      justify-content:center;
      margin: 0 auto 1rem;
      user-select:none;
      width:max-content;
    }
    .puzzle-grid .hdr{
      background:#2a2a2a; border:1px solid #555; border-radius:.5rem; display:flex; align-items:center; justify-content:center;
      height:48px; font-weight:600;
    }
    /* 讓頂端母音與左側行標 sticky（隨頁面捲動固定） */
    .puzzle-grid .hdr-top{
      position: sticky;
      top: calc(var(--header-height, 60px) + 8px);
      z-index: 2;
    }
    .puzzle-grid .hdr-left{
      position: sticky;
      left: 0;
      z-index: 3;
    }
    .puzzle-grid .hdr-corner{
      position: sticky;
      top: calc(var(--header-height, 60px) + 8px);
      left: 0;
      z-index: 4;
    }

    .drop-cell{
      width:var(--cell); height:var(--cell);
      background:#1f1f1f; border:2px dashed #444; border-radius:.5rem;
      display:flex; align-items:center; justify-content:center;
    }
    .drop-cell.disabled{ opacity:.2; border-style:solid; }
    .drop-cell.over{ border-color:#1e90ff; background:#242b35; }

    .shake{ animation:shake .25s ease; }
    @keyframes shake{
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .puzzle-progress{ text-align:center; margin-top:.5rem; color:#bbb; font-size:.95rem; }

    /* 讓 footer 總是在最上層（若真的重疊，也不會看到破圖鋸齒） */
    .bottom-bar{ position: relative; z-index: 99; }
  </style>
</head>
<body>
  <!-- 導覽 -->
  <header class="top-bar show">
    <a href="index.html" class="logo-link-top"><img class="top-logo" src="logo.png" alt="Logo" /></a>
    <nav class="top-nav show">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <!-- <a href="education.html">Education</a> -->
      <a href="projects.html">Projects</a>
      <a href="interest.html">Interest</a>
      <a href="japanese.html" class="active">五十音練習</a>
    </nav>
  </header>

  <main class="section kana-page">
    <h2>五十音練習</h2>

    <!-- 五十音表（點格子可翻牌顯示羅馬字） -->
    <div class="kana-chart">
      <h3>平假名 & 片假名</h3>
      <table id="base-kana-table">
        <thead>
          <tr><th></th><th>あ</th><th>い</th><th>う</th><th>え</th><th>お</th></tr>
        </thead>
        <tbody>
          <!-- 保留母音行，讓拼圖也有 aiueo 題目 -->
          <tr><th>母音</th><td>あ/ア</td><td>い/イ</td><td>う/ウ</td><td>え/エ</td><td>お/オ</td></tr>

          <tr><th>か</th><td>か/カ</td><td>き/キ</td><td>く/ク</td><td>け/ケ</td><td>こ/コ</td></tr>
          <tr><th>さ</th><td>さ/サ</td><td>し/シ</td><td>す/ス</td><td>せ/セ</td><td>そ/ソ</td></tr>
          <tr><th>た</th><td>た/タ</td><td>ち/チ</td><td>つ/ツ</td><td>て/テ</td><td>と/ト</td></tr>
          <tr><th>な</th><td>な/ナ</td><td>に/ニ</td><td>ぬ/ヌ</td><td>ね/ネ</td><td>の/ノ</td></tr>
          <tr><th>は</th><td>は/ハ</td><td>ひ/ヒ</td><td>ふ/フ</td><td>へ/ヘ</td><td>ほ/ホ</td></tr>
          <tr><th>ま</th><td>ま/マ</td><td>み/ミ</td><td>む/ム</td><td>め/メ</td><td>も/モ</td></tr>
          <tr><th>や</th><td>や/ヤ</td><td></td><td>ゆ/ユ</td><td></td><td>よ/ヨ</td></tr>
          <tr><th>ら</th><td>ら/ラ</td><td>り/リ</td><td>る/ル</td><td>れ/レ</td><td>ろ/ロ</td></tr>
          <tr><th>わ</th><td>わ/ワ</td><td></td><td></td><td></td><td>を/ヲ</td></tr>
          <tr><th>ん</th><td>ん/ン</td><td colspan="4"></td></tr>
        </tbody>
      </table>

      <h3>濁音 & 半濁音</h3>
      <table>
        <thead>
          <tr><th>が/ガ</th><th>ぎ/ギ</th><th>ぐ/グ</th><th>げ/ゲ</th><th>ご/ゴ</th></tr>
        </thead>
        <tbody>
          <tr><td>ざ/ザ</td><td>じ/ジ</td><td>ず/ズ</td><td>ぜ/ゼ</td><td>ぞ/ゾ</td></tr>
          <tr><td>だ/ダ</td><td>ぢ/ヂ</td><td>づ/ヅ</td><td>で/デ</td><td>ど/ド</td></tr>
          <tr><td>ば/バ</td><td>び/ビ</td><td>ぶ/ブ</td><td>べ/ベ</td><td>ぼ/ボ</td></tr>
          <tr><td>ぱ/パ</td><td>ぴ/ピ</td><td>ぷ/プ</td><td>ぺ/ペ</td><td>ぽ/ポ</td></tr>
        </tbody>
      </table>
    </div>

    <!-- 模式選擇 -->
    <div class="quiz-modes">
      <h3>測驗方式</h3>
      <div class="quiz-buttons">
        <button id="quiz-multiple">選擇題模式</button>
        <button id="puzzle-mode">拼圖模式</button>
      </div>
    </div>

    <!-- 選擇題：設定 -->
    <div id="multiple-setup" class="quiz-setup" style="display:none;">
      <h4>選擇模式設定</h4>
      <label><input type="checkbox" id="opt-hira" checked> 平假名</label>
      <label><input type="checkbox" id="opt-kata" checked> 片假名</label>
      <label><input type="checkbox" id="opt-daku"> 包含濁音/半濁音</label>
      <button id="start-multiple">開始測驗</button>
    </div>

    <!-- 選擇題：作答 -->
    <div id="multiple-quiz" class="quiz-question" style="display:none;">
      <div id="question-text"></div>
      <div class="choices" id="choices"></div>
      <div class="controls">
        <button id="return-btn">返回五十音表</button>
        <button id="next-btn">下一題</button>
      </div>
    </div>

    <!-- 拼圖模式設定（預設：正常排列） -->
    <section id="puzzle-setup" class="quiz-setup">
      <h4>拼圖模式設定</h4>
      <div class="setup-row">
        <span>模式：</span>
        <label><input type="radio" name="pz-mode" value="practice" checked> 練習（不計時）</label>
        <label><input type="radio" name="pz-mode" value="timed"> 計時（拖曳開始）</label>
      </div>
      <div class="setup-row">
        <span>排列：</span>
        <label><input type="radio" name="pz-order" value="normal" checked> 正常排列</label>
        <label><input type="radio" name="pz-order" value="shuffle"> 打散順序</label>
      </div>
      <div class="setup-actions">
        <button id="start-puzzle">開始拼圖</button>
        <button id="cancel-puzzle" class="secondary">返回五十音表</button>
      </div>
    </section>

    <!-- 拼圖模式 -->
    <section id="puzzle" class="puzzle-container">
      <div class="puzzle-actions">
        <button id="puzzle-shuffle">重來（重排行列/拼圖）</button>
        <button id="puzzle-exit" class="secondary">返回五十音表</button>
        <div class="timer-box" id="timer-box" style="display:none;">
          <span>計時：</span>
          <button id="timer-reset" class="secondary">停止並重置</button>
          <span id="timer-display">00:00</span>
        </div>
      </div>

      <!-- 可拖曳籃子（會自動貼在拼圖右側；可捲動；可再拖動） -->
      <div id="tile-pool-wrap" class="tile-pool-wrap" aria-live="polite">
        <div id="tile-pool-header" class="tile-pool-header">拼圖籃子（可拖曳）</div>
        <div id="tile-pool" class="tile-pool" aria-label="拼圖散落區"></div>
      </div>

      <!-- 目標表格（行列隨機 or 正常；標頭顯示羅馬拼音） -->
      <div id="puzzle-grid" class="puzzle-grid" aria-label="拼圖目標"></div>

      <div id="puzzle-progress" class="puzzle-progress"></div>
    </section>
  </main>

  <footer class="bottom-bar">© 2025 卓大一</footer>

  <script>
    /* 假名 -> 羅馬拼音對照 */
    const mapping = {
      'あ':'a','い':'i','う':'u','え':'e','お':'o',
      'か':'ka','き':'ki','く':'ku','け':'ke','こ':'ko',
      'さ':'sa','し':'shi','す':'su','せ':'se','そ':'so',
      'た':'ta','ち':'chi','つ':'tsu','て':'te','と':'to',
      'な':'na','に':'ni','ぬ':'nu','ね':'ne','の':'no',
      'は':'ha','ひ':'hi','ふ':'fu','へ':'he','ほ':'ho',
      'ま':'ma','み':'mi','む':'mu','め':'me','も':'mo',
      'や':'ya','ゆ':'yu','よ':'yo',
      'ら':'ra','り':'ri','る':'ru','れ':'re','ろ':'ro',
      'わ':'wa','を':'wo','ん':'n',
      'ア':'a','イ':'i','ウ':'u','エ':'e','オ':'o',
      'カ':'ka','キ':'ki','ク':'ku','ケ':'ke','コ':'ko',
      'サ':'sa','シ':'shi','ス':'su','セ':'se','ソ':'so',
      'タ':'ta','チ':'chi','ツ':'tsu','テ':'te','ト':'to',
      'ナ':'na','ニ':'ni','ヌ':'nu','ネ':'ne','ノ':'no',
      'ハ':'ha','ヒ':'hi','フ':'fu','ヘ':'he','ホ':'ho',
      'マ':'ma','ミ':'mi','ム':'mu','メ':'me','モ':'mo',
      'ヤ':'ya','ユ':'yu','ヨ':'yo',
      'ラ':'ra','リ':'ri','ル':'ru','レ':'re','ロ':'ro',
      'ワ':'wa','ヲ':'wo','ン':'n',
      'が':'ga','ぎ':'gi','ぐ':'gu','げ':'ge','ご':'go',
      'ざ':'za','じ':'ji','ず':'zu','ぜ':'ze','ぞ':'zo',
      'だ':'da','ぢ':'ji','づ':'zu','で':'de','ど':'do',
      'ば':'ba','び':'bi','ぶ':'bu','べ':'be','ぼ':'bo',
      'ぱ':'pa','ぴ':'pi','ぷ':'pu','ぺ':'pe','ぽ':'po',
      'ガ':'ga','ギ':'gi','グ':'gu','ゲ':'ge','ゴ':'go',
      'ザ':'za','ジ':'ji','ズ':'zu','ゼ':'ze','ゾ':'zo',
      'ダ':'da','ヂ':'ji','ヅ':'zu','デ':'de','ド':'do',
      'バ':'ba','ビ':'bi','ブ':'bu','ベ':'be','ボ':'bo',
      'パ':'pa','ピ':'pi','プ':'pu','ペ':'pe','ポ':'po'
    };

    /* ===== 選擇題 ===== */
    const kanaSets = {
      hira: Object.keys(mapping).filter(k => /[ぁ-ゖん]/.test(k)),
      kata: Object.keys(mapping).filter(k => /[ァ-ヶン]/.test(k)),
      daku: ['が','ぎ','ぐ','げ','ご','ざ','じ','ず','ぜ','ぞ','だ','ぢ','づ','で','ど','ば','び','ぶ','べ','ぼ','ぱ','ぴ','ぷ','ぺ','ぽ',
             'ガ','ギ','グ','ゲ','ゴ','ザ','ジ','ズ','ゼ','ゾ','ダ','ヂ','ヅ','デ','ド','バ','ビ','ブ','ベ','ボ','パ','ピ','プ','ペ','ポ']
    };
    const optHira = document.getElementById('opt-hira');
    const optKata = document.getElementById('opt-kata');
    const optDaku = document.getElementById('opt-daku');

    let pool = [], answer = '';
    let quizLocked = false;

    document.getElementById('quiz-multiple').onclick = () => {
      document.querySelector('.kana-chart').style.display = 'none';
      document.querySelector('.quiz-modes').style.display = 'none';
      document.getElementById('multiple-setup').style.display = 'block';
      document.getElementById('puzzle').style.display = 'none';
      document.getElementById('puzzle-setup').style.display = 'none';
      document.getElementById('tile-pool-wrap').style.display = 'none';
    };

    document.getElementById('start-multiple').onclick = () => {
      pool = [];
      if (optHira.checked) pool = pool.concat(kanaSets.hira);
      if (optKata.checked) pool = pool.concat(kanaSets.kata);
      if (optDaku.checked) pool = pool.concat(kanaSets.daku);
      if (!pool.length) return alert('請至少選擇一種音節！');

      document.getElementById('multiple-setup').style.display = 'none';
      document.getElementById('multiple-quiz').style.display = 'block';
      nextQuestion();
    };

    function nextQuestion(){
      quizLocked = false;
      answer = pool[Math.floor(Math.random() * pool.length)];
      document.getElementById('question-text').textContent = '請選出拼音：' + mapping[answer];

      const wrong = pool.filter(k => k !== answer).sort(() => 0.5 - Math.random()).slice(0, 3);
      const opts = [...wrong, answer].sort(() => 0.5 - Math.random());

      const choicesEl = document.getElementById('choices');
      choicesEl.innerHTML = '';

      opts.forEach(k => {
        const wrap = document.createElement('div');
        wrap.className = 'choice';
        const btn = document.createElement('button');
        btn.textContent = k;
        const r = document.createElement('div');
        r.className = 'romaji';
        r.textContent = mapping[k] || '';

        btn.onclick = () => {
          if (quizLocked) return;
          quizLocked = true;
          if (k === answer) btn.classList.add('correct');
          else btn.classList.add('wrong');
          document.querySelectorAll('.choice').forEach(c => c.classList.add('revealed'));
        };

        wrap.appendChild(btn);
        wrap.appendChild(r);
        choicesEl.appendChild(wrap);
      });
    }

    document.getElementById('next-btn').onclick = nextQuestion;
    document.getElementById('return-btn').onclick = () => {
      document.getElementById('multiple-quiz').style.display = 'none';
      document.querySelector('.kana-chart').style.display = 'block';
      document.querySelector('.quiz-modes').style.display = 'block';
      document.getElementById('choices').innerHTML = '';
    };

    /* 表格翻牌：點格子顯示羅馬拼音；移出或再點恢復 */
    document.querySelectorAll('.kana-chart td').forEach(td => {
      const original = td.textContent.trim();
      if (!original) return;
      const baseHira = original.split('/')[0];
      const roma = mapping[baseHira] || mapping[original] || '';
      let flipped = false;

      td.addEventListener('click', () => {
        if (!roma) return;
        flipped = !flipped;
        td.textContent = flipped ? roma : original;
      });
      td.addEventListener('mouseleave', () => {
        if (flipped) {
          flipped = false;
          td.textContent = original;
        }
      });
    });

    /* ===== 拼圖模式：設定流程 ===== */
    const puzzleBtn   = document.getElementById('puzzle-mode');
    const pSetupEl    = document.getElementById('puzzle-setup');
    const startPuzzle = document.getElementById('start-puzzle');
    const cancelPuzzle= document.getElementById('cancel-puzzle');

    puzzleBtn.addEventListener('click', () => {
      document.querySelector('.kana-chart').style.display = 'none';
      document.querySelector('.quiz-modes').style.display = 'none';
      document.getElementById('multiple-setup').style.display = 'none';
      document.getElementById('multiple-quiz').style.display = 'none';
      pSetupEl.style.display = 'block';
      document.getElementById('puzzle').style.display = 'none';
      document.getElementById('tile-pool-wrap').style.display = 'none';
    });

    cancelPuzzle.addEventListener('click', () => {
      pSetupEl.style.display = 'none';
      document.querySelector('.kana-chart').style.display = 'block';
      document.querySelector('.quiz-modes').style.display = 'block';
    });

    /* ===== 拼圖模式本體 ===== */
    const puzzleEl    = document.getElementById('puzzle');
    const gridEl      = document.getElementById('puzzle-grid');
    const poolWrapEl  = document.getElementById('tile-pool-wrap');
    const poolHeader  = document.getElementById('tile-pool-header');
    const poolEl      = document.getElementById('tile-pool');
    const progressEl  = document.getElementById('puzzle-progress');
    const shuffleBtn  = document.getElementById('puzzle-shuffle');
    const exitBtn     = document.getElementById('puzzle-exit');

    /* 計時器（計時模式才顯示；第一次拖曳自動開始） */
    const timerBox    = document.getElementById('timer-box');
    const timerReset  = document.getElementById('timer-reset');
    const timerDisplay= document.getElementById('timer-display');
    let timing = false, startTime = 0, timerInterval = null;
    let timerArmed = false;              // 等第一次拖曳才啟動
    let puzzleMode = 'practice';         // 'practice' | 'timed'
    let shuffleOrder = false;            // 預設正常排列

    function formatTime(ms){
      const s = Math.floor(ms/1000);
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(s%60).padStart(2,'0');
      return `${mm}:${ss}`;
    }
    function startTimer(){
      timing = true; startTime = Date.now();
      clearInterval(timerInterval);
      timerInterval = setInterval(()=> {
        timerDisplay.textContent = formatTime(Date.now() - startTime);
      }, 200);
    }
    function stopTimer(keep=false){
      timing = false;
      clearInterval(timerInterval);
      timerInterval = null;
      if (!keep) timerDisplay.textContent = '00:00';
    }
    function resetTimerAndBoard(){ // 手動停止→歸零並清空重建
      stopTimer(false);
      timerArmed = (puzzleMode === 'timed'); // 等待下一次拖曳才開始
      buildPuzzle();
    }
    timerReset.addEventListener('click', resetTimerAndBoard);

    // ➜ 可拖曳的籃子（拖標題列移動）
    let userMovedPool = false;
    (function enablePoolDragging(){
      let dragging=false, dx=0, dy=0;
      function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
      poolHeader.addEventListener('pointerdown', (e)=>{
        dragging = true; userMovedPool = true;
        poolHeader.setPointerCapture(e.pointerId);
        const r = poolWrapEl.getBoundingClientRect();
        dx = e.clientX - r.left;
        dy = e.clientY - r.top;
      });
      poolHeader.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        let left = e.clientX - dx;
        let top  = e.clientY - dy;
        left = clamp(left, 0, window.innerWidth - poolWrapEl.offsetWidth);
        top  = clamp(top , 0, window.innerHeight - poolWrapEl.offsetHeight);
        poolWrapEl.style.left = left + 'px';
        poolWrapEl.style.top  = top  + 'px';
        poolWrapEl.style.right = 'auto';
        poolWrapEl.style.bottom= 'auto';
      });
      function endDrag(){ dragging=false; }
      poolHeader.addEventListener('pointerup', endDrag);
      poolHeader.addEventListener('lostpointercapture', endDrag);
      window.addEventListener('resize', ()=>{
        if (!userMovedPool) positionPoolNextToGrid();
        adjustPuzzleBottomPadding();
      });
    })();

    // 允許籃子內自由重新定位方塊
    let poolDropBound = false;
    function enablePoolReposition() {
      if (poolDropBound) return;
      poolEl.addEventListener('dragover', (e) => { e.preventDefault(); });
      poolEl.addEventListener('drop', (e) => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const tile = document.getElementById(id);
        if (!tile) return;
        if (tile.classList.contains('placed')) return; // 不回收已放置
        const rect = poolEl.getBoundingClientRect();
        const tw = tile.offsetWidth || 90;
        const th = tile.offsetHeight || 52;
        let left = e.clientX - rect.left - tw / 2;
        let top  = e.clientY - rect.top  - th / 2;
        left = Math.max(0, Math.min(left, rect.width  - tw));
        top  = Math.max(0, Math.min(top , rect.height - th));
        tile.style.left = `${left}px`;
        tile.style.top  = `${top}px`;
        tile.setAttribute('draggable', 'true');
        poolEl.appendChild(tile);
      });
      poolDropBound = true;
    }
    enablePoolReposition();

    // 拖曳時靠近上下緣自動滾動頁面
    document.addEventListener('dragover', (e) => {
      const margin = 80;
      if (e.clientY < margin)      window.scrollBy(0, -12);
      else if (e.clientY > innerHeight - margin) window.scrollBy(0, 12);
    });

    // 從 Base 表格讀取拼圖資料
    function readTilesFromBaseTable(){
      const base = document.getElementById('base-kana-table');
      const cols = [...base.querySelectorAll('thead th')].slice(1).map(th => th.textContent.trim()); // ["あ","い","う","え","お"]
      const tiles = [];
      base.querySelectorAll('tbody tr').forEach(tr => {
        const rowLabel = tr.querySelector('th').textContent.trim(); // "母音","か","さ",...
        tr.querySelectorAll('td').forEach((td, idx) => {
          const txt = td.textContent.trim();
          if (!txt) return; // 空白略過
          const colLabel = cols[idx]; // "あ","い","う","え","お"
          tiles.push({ row: rowLabel, col: colLabel, text: txt });
        });
      });
      return tiles;
    }

    function shuffle(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    let puzzleTiles = [];
    let placedCount = 0;

    function hdrCell(text, cls='hdr'){
      const d = document.createElement('div');
      d.className = cls;
      d.textContent = text;
      return d;
    }

    function updateProgress(){
      progressEl.textContent = `已放置：${placedCount} / ${puzzleTiles.length}` + (placedCount === puzzleTiles.length ? ' ✅ 完成！' : '');
      if (placedCount === puzzleTiles.length && timing){
        stopTimer(true); // 完成時停止並保留讀數
      }
    }

    // 初始鋪排：以容器寬度決定欄數；列數可超出高度，溢出靠捲動
    function scatterTiles(tileEls){
      const rect = poolEl.getBoundingClientRect();
      const tileW = 90, tileH = 52, gap = 10;

      const cols = Math.max(1, Math.floor((rect.width  - gap) / (tileW + gap)));
      const rows = Math.ceil(tileEls.length / cols);

      tileEls.forEach((tile, i) => {
        const col = i % cols;
        const row = Math.floor(i / cols);
        let x = gap + col * (tileW + gap);
        let y = gap + row * (tileH + gap);
        x += (Math.random() * 6 - 3);
        y += (Math.random() * 6 - 3);
        tile.style.left = `${x}px`;
        tile.style.top  = `${y}px`;
      });
    }

    // ✅ 智慧把籃子放到拼圖右邊，不遮擋題目
    function positionPoolNextToGrid() {
      poolWrapEl.style.display = 'block'; // 需要可量到尺寸
      const minW = 280, maxW = 380, idealVW = Math.floor(window.innerWidth * 0.34);
      let targetW = Math.min(maxW, Math.max(minW, idealVW));

      const g = gridEl.getBoundingClientRect();
      const margin = 12;
      const spaceRight = window.innerWidth - g.right - margin - 8; // 右緣空間
      if (spaceRight >= minW) {
        targetW = Math.min(targetW, spaceRight);
        poolWrapEl.style.width = targetW + 'px';
        const top = Math.max(8, g.top);
        const left = Math.min(window.innerWidth - targetW - 8, g.right + margin);
        poolWrapEl.style.left = left + 'px';
        poolWrapEl.style.top  = top + 'px';
        poolWrapEl.style.right = 'auto';
        poolWrapEl.style.bottom= 'auto';
      } else {
        poolWrapEl.style.width = targetW + 'px';
        poolWrapEl.style.right = '16px';
        poolWrapEl.style.bottom= '16px';
        poolWrapEl.style.left = 'auto';
        poolWrapEl.style.top  = 'auto';
      }
    }

    // ▶︎ 依 footer 高度動態加大拼圖容器的底部留白，避免 sticky 行/列撞上 footer
    function adjustPuzzleBottomPadding() {
      const footer = document.querySelector('.bottom-bar');
      const fh = footer ? footer.getBoundingClientRect().height : 80;
      // 多預留一點緩衝（24px）
      puzzleEl.style.paddingBottom = (fh + 24) + 'px';
    }

    function buildPuzzle(){
      puzzleTiles = readTilesFromBaseTable();
      placedCount = 0;

      const rowLabelsKana = [...new Set(puzzleTiles.map(t => t.row))];
      const colLabelsKana = [...new Set(puzzleTiles.map(t => t.col))];

      const rowOrderKana  = shuffleOrder ? shuffle(rowLabelsKana) : rowLabelsKana.slice();
      const colOrderKana  = shuffleOrder ? shuffle(colLabelsKana) : colLabelsKana.slice();

      const rowOrderRoma = rowOrderKana.map(k => mapping[k] || k);
      const colOrderRoma = colOrderKana.map(k => mapping[k] || k);

      const validKey = new Set(puzzleTiles.map(t => `${t.row}|${t.col}`));

      // 建立目標網格
      gridEl.innerHTML = '';
      gridEl.appendChild(hdrCell('', 'hdr hdr-top hdr-left hdr-corner')); // 左上角
      colOrderRoma.forEach(c => gridEl.appendChild(hdrCell(c, 'hdr hdr-top')));

      rowOrderKana.forEach((rKana, rIdx) => {
        gridEl.appendChild(hdrCell(rowOrderRoma[rIdx], 'hdr hdr-left'));
        colOrderKana.forEach(cKana => {
          const cell = document.createElement('div');
          const exists = validKey.has(`${rKana}|${cKana}`);
          cell.className = 'drop-cell' + (exists ? '' : ' disabled');
          if (exists) {
            cell.dataset.row = rKana;
            cell.dataset.col = cKana;
            cell.addEventListener('dragover', e => e.preventDefault());
            cell.addEventListener('dragenter', e => { e.preventDefault(); cell.classList.add('over'); });
            cell.addEventListener('dragleave', () => cell.classList.remove('over'));
            cell.addEventListener('drop', e => {
              e.preventDefault();
              cell.classList.remove('over');
              const id = e.dataTransfer.getData('text/plain');
              const tile = document.getElementById(id);
              if (!tile) return;
              if (tile.dataset.row === cell.dataset.row && tile.dataset.col === cell.dataset.col) {
                cell.innerHTML = '';
                tile.classList.add('placed');
                tile.removeAttribute('style');
                tile.setAttribute('draggable', 'false');
                cell.appendChild(tile);
                placedCount++;
                updateProgress();
              } else {
                tile.classList.remove('shake'); void tile.offsetWidth; tile.classList.add('shake');
              }
            });
          }
          gridEl.appendChild(cell);
        });
      });

      // 生成散落拼圖塊（正常排列時：籃子內容仍隨機）
      poolEl.innerHTML = '';
      const tileEls = [];
      const poolTiles = (!shuffleOrder) ? shuffle(puzzleTiles) : puzzleTiles.slice();

      poolTiles.forEach((t, idx) => {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.id = `tile-${idx}`;
        tile.textContent = t.text;
        tile.setAttribute('draggable','true');
        tile.dataset.row = t.row;
        tile.dataset.col = t.col;

        tile.addEventListener('dragstart', e => {
          e.dataTransfer.setData('text/plain', tile.id);
          if (puzzleMode === 'timed' && timerArmed && !timing){
            startTimer();
            timerArmed = false;
          }
        });

        poolEl.appendChild(tile);
        tileEls.push(tile);
      });

      // 顯示、定位籃子到拼圖右邊，然後散佈方塊
      puzzleEl.style.display = 'block';
      poolWrapEl.style.display = 'block';
      if (!userMovedPool) positionPoolNextToGrid();
      adjustPuzzleBottomPadding(); // ★ 依 footer 動態加底部留白
      requestAnimationFrame(() => scatterTiles(tileEls));

      updateProgress();

      // 計時模式預備
      if (puzzleMode === 'timed'){
        stopTimer(false);
        timerArmed = true;
      }

      gridEl.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // 從設定面板開始拼圖
    startPuzzle.addEventListener('click', () => {
      puzzleMode   = (document.querySelector('input[name="pz-mode"]:checked')?.value || 'practice');
      shuffleOrder = (document.querySelector('input[name="pz-order"]:checked')?.value || 'normal') === 'shuffle';

      // 顯示/隱藏計時器盒
      timerBox.style.display = (puzzleMode === 'timed') ? 'flex' : 'none';

      userMovedPool = false; // 每次開始由系統先擺好位置
      pSetupEl.style.display = 'none';
      buildPuzzle();
    });

    // 重來（保持目前設定）
    shuffleBtn.addEventListener('click', () => {
      if (puzzleMode === 'timed'){
        stopTimer(false);
        timerArmed = true;
      }
      buildPuzzle();
    });

    // 離開拼圖模式
    exitBtn.addEventListener('click', () => {
      stopTimer(false);
      timerArmed = false;
      document.getElementById('puzzle').style.display = 'none';
      document.querySelector('.kana-chart').style.display = 'block';
      document.querySelector('.quiz-modes').style.display = 'block';
      poolWrapEl.style.display = 'none';
    });

    // 初次載入也計一次下方留白（若直接從拼圖開始）
    window.addEventListener('load', adjustPuzzleBottomPadding);
  </script>
</body>
</html>
